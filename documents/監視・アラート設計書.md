# 監視・アラート設計書

## 1. 監視設計方針

### 1-1. 基本方針

本システムの監視設計は、**SLI/SLOの達成を確実にする**ことを最優先とする。

**重要な目標値**
- **可用性**: 99.5%（月間ダウンタイム3.6時間以内）
- **障害検知時間**: 3分以内
- **APIレイテンシ**: 95%ile 1秒以内
- **画面レイテンシ**: 95%ile 3秒以内

**前提条件**

本設計はDatadog有料プラン（Pro以上）を前提としています。

**ポートフォリオ作成時の運用計画**:
1. **14日間無料トライアル**: 全機能を使用してPhase 4-6（インフラ構築・負荷テスト・SLO検証）を集中的に実施
2. **トライアル終了後**: 無料プランに自動移行（機能制限あり）
3. **成果物**: トライアル期間中にスクリーンショット等で記録

**無料プランの機能制限**:
- **データ保持期間**: 1日間のみ（設計では15ヶ月）→ 28日間のSLO測定が不可
- **SLO管理機能**: 制限あり → エラーバジェット管理が困難
- **ログ管理**: 非常に限定的 → 長期的なログ分析が不可
- **APM**: 制限あり → トレース分析が困難

無料プラン移行後は、基本的な監視（タスク数、メトリクス確認）のみ継続可能です。

---

### 1-2. CloudWatchとDatadogの役割分担

| ツール | 役割 | 保持期間 | 用途 |
|--------|------|---------|------|
| **CloudWatch** | Fargateログ出力先（必須）、AWS標準メトリクス | 7日間 | 短期ログ保存、Datadog転送元 |
| **Datadog** | 統合監視・分析プラットフォーム | 15ヶ月 | ログ・メトリクス・トレース統合分析、SLO管理、異常検知 |

---

## 2. メトリクス・アラート設計

以下のメトリクスを監視し、Critical閾値を超えた場合にアラートを発火する。

| メトリクス | 測定内容 | Critical閾値 | 理由 | 測定ソース |
|-----------|---------|-------------|------|-----------|
| **可用性** | 成功リクエスト数 / 全リクエスト数（28日間） | 95%未満（3分継続） | SLO違反の可能性 | Datadog APM |
| **APIレイテンシ** | API応答時間95パーセンタイル（28日間） | 3秒超（3分継続） | レイテンシSLO違反（目標1秒の3倍） | Datadog APM |
| **エラー率** | 5xxエラー数 / 全リクエスト数 | 5%超（3分継続） | 可用性SLO違反（目標0.5%の10倍） | Datadog APM |
| **タスク数** | ECS実行中タスク数 | 0個（3分継続） | システムダウン | CloudWatch Container Insights |
| **ターゲット正常数** | ALBヘルスチェック成功数 | 0個（3分継続） | バックエンド全滅 | CloudWatch ALB |
| **DB接続数** | RDSアクティブ接続数 | 最大接続数の90%超 | 接続枯渇でエラー（もうすぐ壊れる） | CloudWatch RDS |
| **メモリ使用率** | Fargateタスクメモリ使用率 | 90%超（3分継続） | OOM Kill（もうすぐ壊れる） | CloudWatch Container Insights |
| **ストレージ空き容量** | RDS残りストレージ | 10%未満 | ディスク満杯でDB停止（もうすぐ壊れる） | CloudWatch RDS |
| **CPU使用率（ECS）** | Fargateタスク平均CPU使用率 | - | 障害調査時の原因特定 | CloudWatch Container Insights |
| **CPU使用率（RDS）** | DB CPU使用率 | - | 障害調査時の原因特定 | CloudWatch RDS |

**注**: CloudWatchメトリクスはDatadogに転送して統合管理します。

---

**アラート発火条件**

上記メトリクスがCritical閾値を超えた場合、Email通知を発火する（3分以内に検知）。

**アラートを出さない指標**

以下の指標は監視・記録するが、アラートは発火させない（症状が出た際の原因調査に使用）:
- メモリ使用率（90%未満）: トレンド分析、メモリリーク検知
- スロークエリ: レイテンシ悪化時の原因特定

**理由**: CPU/メモリ使用率などの「原因」でアラートを出すと誤検知が多発。レイテンシ悪化などの「症状」が出た際に原因調査で確認すれば十分。

---

## 3. ダッシュボード設計

### 3-1. SLO管理ダッシュボード

**目的**: SLO達成状況の可視化、エラーバジェット管理

**表示項目**
- 可用性SLO（現在値、目標99.5%、エラーバジェット残量）
- APIレイテンシSLO（現在値、目標1秒、p95グラフ）
- 画面レイテンシSLO（現在値、目標3秒、p95グラフ）

**更新頻度**: 1時間ごと

---

### 3-2. リアルタイム監視ダッシュボード

**目的**: システム状態のリアルタイム把握、障害の早期検知

**表示項目**
- リクエスト数/秒、エラー率、レスポンスタイム（p95）
- ECSタスク数、ALBターゲット正常数
- アクティブアラート一覧

**更新頻度**: 1分ごと

---

### 3-3. トラブルシューティングダッシュボード

**目的**: 障害発生時の原因特定を迅速化

**表示項目**
- エラーログ（過去1時間、ERROR/CRITICAL level）
- APMトレース（遅いリクエスト、エラートレース）
- インフラ詳細（タスク別CPU/メモリ、DB接続数、スロークエリ）

**更新頻度**: リアルタイム

**注**: CPU/メモリ使用率はアラートを出さないが、障害調査時の原因特定に使用するためダッシュボードには表示する。

---

## 4. ログ収集・保持方針

### 4-1. ログの種類と保持期間

| ログ種別 | 出力元 | CloudWatch保持期間 | Datadog保持期間 | 用途 |
|---------|-------|-------------------|----------------|------|
| **アプリケーションログ** | Fargate（stdout/stderr） | 7日間 | 15ヶ月 | エラー調査、トラブルシューティング |
| **アクセスログ** | ALB | 7日間 | 15ヶ月 | トラフィック分析、レイテンシ分析 |
| **データベースログ** | RDS（スロークエリ、エラー） | 7日間 | 15ヶ月 | クエリ最適化、障害調査 |
| **監査ログ** | IAM、VPC Flow Logs | 90日間 | 15ヶ月 | セキュリティ監査、不正アクセス調査 |

**保持期間の理由**
- **CloudWatch 7日間**: コスト削減（長期保存はDatadogで実施）
- **Datadog 15ヶ月**: 過去との比較分析、トレンド把握、コンプライアンス対応

---

### 4-2. ログレベル定義

**アプリケーションログのレベル**

| レベル | 用途 | 出力条件 | 例 |
|--------|------|---------|-----|
| **CRITICAL** | システム停止レベルの致命的エラー | 即座対応必須 | DB接続不可、外部API全滅 |
| **ERROR** | 処理失敗、要調査 | 30分以内対応 | API呼び出し失敗、バリデーションエラー |
| **WARNING** | 注意が必要だが処理継続可能 | 翌営業日対応 | リトライ成功、非推奨機能使用 |
| **INFO** | 正常系の重要イベント | 傾向分析 | リクエスト受信、処理完了 |
| **DEBUG** | デバッグ情報 | 本番環境では無効化 | 変数値、処理フロー詳細 |

**本番環境のログレベル**: INFO以上（DEBUGは無効化してログ容量削減）

---

### 4-3. ログフォーマット

**構造化ログ（JSON形式）を採用**

**必須フィールド**:
- timestamp: タイムスタンプ（ISO 8601形式）
- level: ログレベル（CRITICAL/ERROR/WARNING/INFO/DEBUG）
- service: サービス名
- message: ログメッセージ
- trace_id/span_id: APMトレースとの紐付け用

**理由**:
- Datadogでフィルタ・集計が容易
- APMトレースとログの紐付けが可能
- タイムゾーン問題の回避

---

## 5. 次のステップ

本設計書をもとに、Phase 4で以下のタスクを実装:

- **#37 CloudWatch Logs設定**: ロググループ作成、保持期間7日
- **#38 Datadog連携設定**: Agent設定、ログ転送、APM設定
- **#39 Datadog監視設定**: ダッシュボード・アラート・SLO設定

---

以上