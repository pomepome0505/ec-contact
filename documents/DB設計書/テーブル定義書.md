# テーブル定義書

## 概要

ECサイト問い合わせ対応システムのテーブル定義書です。

---

## テーブル一覧

| テーブル物理名 | テーブル論理名 | 説明 |
|--------------|--------------|------|
| inquiries | 問い合わせ | 顧客からの問い合わせ情報（メタデータ）を管理 |
| users | サポート担当者 | ログイン認証とサポート担当者情報 |
| inquiry_messages | 問い合わせメッセージ | 問い合わせに紐づくすべてのメッセージ（最初の問い合わせ、顧客の返信、担当者の返信）を管理 |

---

## 1. inquiries (問い合わせ)

### 概要
顧客からの問い合わせ情報（メタデータ）を管理するテーブル。メッセージ内容は`inquiry_messages`テーブルで管理。

### テーブル定義

| 物理名 | 論理名 | データ型 | NULL | デフォルト値 | インデックス | 外部キー | 備考 |
|--------|--------|----------|------|-------------|------------|---------|------|
| id | ID | BIGINT UNSIGNED | NO | AUTO_INCREMENT | PRIMARY KEY | - | 主キー |
| inquiry_number | 受付番号 | VARCHAR(20) | NO | - | UNIQUE | - | 一意の受付番号 (例: INQ-20260213-0001) |
| staff_id | 担当者ID | BIGINT UNSIGNED | YES | NULL | INDEX | users.id (ON DELETE SET NULL) | 割り当てられたサポート担当者のID |
| order_number | 注文番号 | VARCHAR(50) | YES | NULL | - | - | 顧客の注文番号 (任意) |
| category | カテゴリ | VARCHAR(20) | NO | - | INDEX | - | 'product', 'order', 'shipping', 'return', 'system', 'other' (Enum想定) |
| customer_name | 顧客氏名 | VARCHAR(100) | NO | - | - | - | 問い合わせした顧客の氏名 |
| customer_email | 顧客メールアドレス | VARCHAR(100) | NO | - | - | - | 返信メールの送信先 |
| status | ステータス | VARCHAR(20) | NO | 'pending' | INDEX | - | 'pending', 'in_progress', 'resolved', 'closed' (Enum想定) |
| priority | 優先度 | VARCHAR(20) | NO | 'medium' | INDEX | - | 'low', 'medium', 'high', 'urgent' (Enum想定) |
| internal_notes | 対応メモ | TEXT | YES | NULL | - | - | 社内向けメモ（顧客非公開、上書き更新） |
| created_at | 作成日時 | TIMESTAMP | NO | CURRENT_TIMESTAMP | INDEX | - | 受付日時 |
| updated_at | 更新日時 | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | - | 最終更新日時 |

### カテゴリ (category)

| 値 | 日本語表記 |
|----|-----------|
| product | 商品について |
| order | 注文・支払いについて |
| shipping | 配送について |
| return | 返品・交換について |
| system | システム・アカウントについて |
| other | その他 |

### ステータス (status)

| 値 | 日本語表記 | 説明 |
|----|-----------|------|
| pending | 未対応 | 受付済み、まだ対応していない |
| in_progress | 対応中 | 対応作業中 |
| resolved | 対応完了 | 対応完了、顧客確認待ち |
| closed | クローズ | 完全にクローズ |

**ステータス遷移**: `pending → in_progress → resolved → closed`

### 優先度 (priority)

| 値 | 日本語表記 |
|----|-----------|
| low | 低 |
| medium | 中 |
| high | 高 |
| urgent | 緊急 |

### 受付番号フォーマット

**フォーマット**: `INQ-YYYYMMDD-XXXX`  
**例**: `INQ-20260213-0001`

**生成ルール**:
- `INQ`: 固定プレフィックス
- `YYYYMMDD`: 受付日（例: 20260213）
- `XXXX`: その日の受付順の連番（0001から）

---

## 2. users (サポート担当者)

### 概要
サポート担当者のログイン認証と情報管理。

### テーブル定義

| 物理名 | 論理名 | データ型 | NULL | デフォルト値 | インデックス | 外部キー | 備考 |
|--------|--------|----------|------|-------------|------------|---------|------|
| id | ID | BIGINT UNSIGNED | NO | AUTO_INCREMENT | PRIMARY KEY | - | 主キー |
| login_id | ログインID | VARCHAR(50) | NO | - | UNIQUE | - | ログインに使用するID（例: staff001, tanaka） |
| name | 氏名 | VARCHAR(255) | NO | - | - | - | サポート担当者の氏名 |
| password | パスワード | VARCHAR(255) | NO | - | - | - | ハッシュ化されたパスワード |
| created_at | 作成日時 | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | - | - |
| updated_at | 更新日時 | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | - | - |

---

## 3. inquiry_messages (問い合わせメッセージ)

### 概要
問い合わせに紐づくすべてのメッセージを管理。最初の問い合わせ、顧客の返信、担当者の返信を一元管理。

### テーブル定義

| 物理名 | 論理名 | データ型 | NULL | デフォルト値 | インデックス | 外部キー | 備考 |
|--------|--------|----------|------|-------------|------------|---------|------|
| id | ID | BIGINT UNSIGNED | NO | AUTO_INCREMENT | PRIMARY KEY | - | 主キー |
| inquiry_id | 問い合わせID | BIGINT UNSIGNED | NO | - | INDEX | inquiries.id (ON DELETE CASCADE) | 紐づく問い合わせのID |
| staff_id | 担当者ID | BIGINT UNSIGNED | YES | NULL | INDEX | users.id (ON DELETE SET NULL) | 送信者が担当者の場合のID（message_type='staff_reply'の場合のみ） |
| message_type | メッセージ種別 | VARCHAR(20) | NO | - | - | - | 'initial_inquiry', 'customer_reply', 'staff_reply' (Enum想定) |
| subject | 件名 | VARCHAR(200) | NO | - | - | - | メッセージ件名 |
| body | 本文 | TEXT | NO | - | - | - | メッセージ本文 |
| created_at | 作成日時 | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | - | 送信日時 |
| updated_at | 更新日時 | TIMESTAMP | NO | CURRENT_TIMESTAMP | - | - | 更新日時 |

### メッセージ種別 (message_type)

| 値 | 説明 | 使用タイミング | 送信者 |
|----|------|---------------|--------|
| initial_inquiry | 最初の問い合わせ | 顧客がフォームから問い合わせ送信時 | 顧客 (staff_id=NULL) |
| customer_reply | 顧客からの返信 | Phase 1: 担当者が受信メールを手動転記時<br>Phase 2: メール受信機能で自動登録時 | 顧客 (staff_id=NULL) |
| staff_reply | 担当者からの返信 | 担当者がシステムから返信メール送信時 | 担当者 (staff_id=値あり) |

---

## マイグレーション作成順序

外部キー制約を考慮した作成順序:

1. `users`
2. `inquiries`
3. `inquiry_messages`